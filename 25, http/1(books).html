<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Books</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
      body {
        background-color: burlywood;
      }

      button {
        cursor: pointer;
      }

      .hidden {
        display: none;
      }

      .book-cover,
      .edit-cover-current {
        max-width: 300px;
        display: block;
        margin-bottom: 10px;
        margin-top: 5px;
      }

      .lds-ring {
        display: inline-block;
        position: relative;
        width: 80px;
        height: 80px;
      }
      .lds-ring div {
        box-sizing: border-box;
        display: block;
        position: absolute;
        width: 64px;
        height: 64px;
        margin: 8px;
        border: 8px solid #fff;
        border-radius: 50%;
        animation: lds-ring 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
        border-color: #fff transparent transparent transparent;
      }
      .lds-ring div:nth-child(1) {
        animation-delay: -0.45s;
      }
      .lds-ring div:nth-child(2) {
        animation-delay: -0.3s;
      }
      .lds-ring div:nth-child(3) {
        animation-delay: -0.15s;
      }
      @keyframes lds-ring {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="library-wrapper">
      <h1>Электронная библиотека</h1>
      <h2>Добавление книги</h2>
      <form class="add-form">
        <input type="text" class="input-author" placeholder="Автор" />
        <input type="text" class="input-title" placeholder="Название книги" />
        <input type="file" name="cover" class="input-cover" />
        <button class="add-btn" type="submit">Добавить</button>
      </form>

      <h3>Список книг</h3>
      <div class="loader-wrapper hidden">
        <div class="lds-ring">
          <div></div>
          <div></div>
          <div></div>
          <div></div>
        </div>
      </div>
      <div class="books"></div>
    </div>

    <div class="edit-wrapper hidden">
      <h1>Редактирование книги</h1>
      <form class="edit-form">
        <input type="text" class="edit-author" />
        <input type="text" class="edit-title" />
        <img class="edit-cover-current" />
        <p>Загрузите новую обложку, если хотите поменять текущую</p>
        <input type="file" name="cover" class="edit-cover" />
        <button class="update-btn" type="submit">Обновить</button>
        <button class="cancel-btn">Отмена</button>
      </form>
    </div>

    <script>
      const libraryWrapper = document.querySelector(".library-wrapper");
      const booksDiv = document.querySelector(".books");
      const addForm = document.querySelector(".add-form");
      const editForm = document.querySelector(".edit-form");
      const commentForm = document.querySelector(".comment-form");
      const editWrapper = document.querySelector(".edit-wrapper");
      const editAuthorInput = document.querySelector(".edit-author");
      const editTitleInput = document.querySelector(".edit-title");
      const editCoverInput = document.querySelector(".edit-cover");
      const editCoverCurrentImg = document.querySelector(".edit-cover-current");
      const cancelBtn = document.querySelector(".cancel-btn");
      const inputCover = document.querySelector(".input-cover");
      const authorInput = document.querySelector(".input-author");
      const titleInput = document.querySelector(".input-title");
      const loaderWrapper = document.querySelector(".loader-wrapper");
      const URL = "https://nordic-books-api.herokuapp.com";
      const userId = "g-anka";

      //СОЗДАНИЕ ЭЛЕМЕНТОВ КНИГИ
      function createBooksElements(arr) {
        //удалить все дочерние узлы дива books, если они есть
        // чтоб очистить старые данные и отобразить новые
        while (booksDiv.firstChild) {
          booksDiv.removeChild(booksDiv.firstChild);
        }
        arr.forEach((item, index) => {
          booksDiv.insertAdjacentHTML("beforeend",
          `
          <div class="book-wrapper">
            <div class="book-body">
                <p class="book-author">${arr[index].author}</p>
                <p class="book-title">${arr[index].title}</p>
                <img class="book-cover" src="${arr[index].imageUrl}"/>
                <div>
                    <button class="btn-del" data-id="${arr[index]._id}">Удалить</button>
                    <button class="btn-edit" data-id="${arr[index]._id}">Редактировать</button>
                    <button class="btn-comment" data-id="${arr[index]._id}">Показать комментарии</button>
                </div>
            </div>
            <div class="book-comments">

            </div>
          </div>
          `)
        });
      }

      //ПОЛУЧЕНИЕ ВСЕХ КНИГ
      async function getBooks() {
        try {
          if (loaderWrapper.classList.contains("hidden")) {
            loaderWrapper.classList.remove("hidden");
          }
          const response = await fetch(`${URL}/books`, {
            method: "GET",
            headers: {"user-id": userId},
          })
          const books = await response.json()
          return books
        } catch (error) {
          console.log("Произошла ошибка!", error)
        }
      }

      getBooks().then((books) => {
        console.log("data GET", books.data);
        createBooksElements(books.data);
        loaderWrapper.classList.add("hidden");
      })


      //ДОБАВЛЕНИЕ КНИГИ
      addForm.addEventListener("submit", function (event) {
        event.preventDefault();
        const formData = new FormData();
        formData.append("author", authorInput.value);
        formData.append("title", titleInput.value);
        formData.append("cover", inputCover.files[0]);

        loaderWrapper.classList.remove("hidden");
        fetch(`${URL}/books`, {
          method: "POST",
          headers: { "user-id": userId },
          body: formData,
        })
          .then((res) => res.json())
          .then(() => {
            getBooks();
            console.log("Новая книга добавлена");
          });

        //очистка инпутов после добавления новой книги
        document.querySelector(".add-form").reset();
      });

      //УДАЛЕНИЕ КНИГИ
      booksDiv.addEventListener("click", function (event) {
        console.log("event.target", event.target);
        let currentId = event.target.dataset.id;
        console.log("currentId: ", currentId);
        if (event.target.classList.contains("btn-del")) {
          fetch(`${URL}/books/${currentId}`, {
            method: "DELETE",
            headers: { "user-id": userId },
          }).then(() => {
            getBooks();
            console.log("Выбранная книга и автор удалены");
          });
          //РЕДАКТИРОВАНИЕ
        } else if (event.target.classList.contains("btn-edit")) {
          libraryWrapper.classList.add("hidden");
          editWrapper.classList.remove("hidden");

          fetch(`${URL}/books/${currentId}`)
            .then((response) => response.json())
            .then((data) => {
              console.log("data EDIT", data);
              editAuthorInput.value = data.author;
              editTitleInput.value = data.title;
              editCoverCurrentImg.src = data.imageUrl;
            })
            .catch((error) => console.log(error));
        }
        //обновить данные редактирования
        editForm.addEventListener("submit", function (event) {
          event.preventDefault();
          const formData = new FormData();
          formData.append("author", editAuthorInput.value);
          formData.append("title", editTitleInput.value);
          formData.append("cover", editCoverInput.files[0]);

          fetch(`${URL}/books/${currentId}`, {
            method: "PUT",
            headers: { "user-id": userId },
            body: formData,
            /* headers: {
                    'Content-Type': 'multipart/form-data',
                }*/
          })
            .then((response) => response.json())
            .then((data) => {
              console.log("data PUT", data);
              editWrapper.classList.add("hidden");
              libraryWrapper.classList.remove("hidden");
              getBooks();
              console.log("Данные книги отредактированы!");
            })
            .catch((error) => console.log(error));
        });
      });

      //отмена редактирования
      cancelBtn.addEventListener("click", function () {
        editWrapper.classList.add("hidden");
        libraryWrapper.classList.remove("hidden");
      });

      //ПОКАЗАТЬ РАЗДЕЛ КОММЕНТАРИЕВ
      booksDiv.addEventListener("click", function (event) {
        const bookComments = document.querySelector(".book-comments");
        if (!event.target.classList.contains("btn-comment")) {
          return
        } else if (event.target.innerText === "Показать комментарии") {
          bookComments.insertAdjacentHTML("beforeend",
          `
          <h2>Добавить новый комментарий</h2>
             <form class="comment-form">
               <input type="text" class="comment-name" placeholder="Ваше имя"/>
               <textarea class="comment-text" placeholder="Ваш комментарий"></textarea>
               <button class="btn-send-comment" type="submit">Отправить</button>
             </form>
        `);
          event.target.innerText = 'Скрыть комментарии';
        } else if (event.target.innerText === "Скрыть комментарии") {
            event.target.innerText = 'Показать комментарии';
            while (bookComments.firstChild) {
              bookComments.removeChild(bookComments.firstChild);
            }
        }
      })

      //ДОБАВИТЬ КОММЕНТАРИЙ
      if(commentForm) {
        commentForm.addEventListener("submit", function (event) {
          event.preventDefault();
          console.log("works")
        })
      }

      /*const name = event.target.querySelector(".comment-name").value;
        const text = event.target.querySelector(".comment-text").value;

        if(name & text) {
          console.log("AAA", name, text)
        }

        fetch(`${URL}/books/${id}/comments`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name,
          text,
        }),
      })
      })
      */

      //инициализация
      window.onload = getBooks;
    </script>
  </body>
</html>
